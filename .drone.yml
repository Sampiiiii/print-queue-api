kind: pipeline
name: deploy
type: docker
concurrency:
  limit: 1
steps:
  - name: slack-begin
    image: plugins/slack
    settings:
      webhook:
        from_secret: slack_webhook
      username: Drone
      icon_url: ${DRONE_COMMIT_AUTHOR_AVATAR}
      template: >
        {{repo.name}}/{{build.branch}} - Started #{{build.number}} "${DRONE_COMMIT_MESSAGE}" by ${DRONE_COMMIT_AUTHOR} (${DRONE_COMMIT_AUTHOR_EMAIL}) (<{{build.link}}|Open>)

- name: build
  environment:
    VAULT_MASTER_SSH_PRIV_KEY:
      from_secret: VAULT_MASTER_SSH_PRIV_KEY
    VAULT_MASTER_SSH_PUB_KEY:
      from_secret: VAULT_MASTER_SSH_PUB_KEY
    VAULT_MASTER_DB_PASS:
      from_secret: VAULT_MASTER_DB_PASS
    VAULT_MASTER_SECRET_KEY:
      from_secret: VAULT_MASTER_SECRET_KEY

  image: devforth/drone-builder
  commands:
  - cd deploy && /bin/bash build.sh
  - name: slack-end
    image: plugins/slack
    settings:
      webhook:
        from_secret: slack_webhook
      username: Drone
      icon_url: ${DRONE_COMMIT_AUTHOR_AVATAR}
      template: >
        {{repo.name}}/{{build.branch}} - #{{build.number}} {{uppercasefirst build.status}} after {{since build.started}} (<{{build.link}}|Open>)
